<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åºŠå«å¯è§†åŒ–ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-item {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .status-connected {
            background: rgba(76,175,80,0.8);
        }

        .status-disconnected {
            background: rgba(244,67,54,0.8);
        }

        .main-content {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .pressure-section {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            overflow: visible;
        }
        
        .matrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .toggle-matrix-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-matrix-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
        }
        
        .toggle-matrix-btn.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .pressure-matrix-display {
            margin-bottom: 25px;
            transition: all 0.4s ease;
            overflow: hidden;
        }
        
        .pressure-matrix-display.collapsed {
            height: 0 !important;
            margin-bottom: 0;
            opacity: 0;
        }
        
        #pressureMatrix {
            font-weight: 500;
            letter-spacing: 0.5px;
            overflow: hidden;
            transition: opacity 0.3s ease;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .pressure-grid {
            display: grid;
            grid-template-columns: repeat(26, 1fr);
            gap: 1px;
            background: #333;
            padding: 10px;
            border-radius: 10px;
            max-width: 650px;
            margin: 0 auto;
        }

        .pressure-cell {
            width: 20px;
            height: 15px;
            background: #000;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .metrics-section {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .metric-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }

        .posture-display {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin: 20px 0;
        }

        .posture-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .posture-text {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .airbag-control {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            margin-top: 30px;
        }

        .airbag-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .airbag-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 120px;
        }

        .airbag-rectangle {
            border-color: #4CAF50;
            background: rgba(76,175,80,0.2);
        }

        .airbag-circle {
            border-color: #2196F3;
            background: rgba(33,150,243,0.2);
        }

        .airbag-number {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 6px;
            color: #fff;
        }

        .airbag-height-display {
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 8px;
        }

        .height-value {
            font-weight: bold;
            color: #fff;
        }

        .airbag-controls {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .height-slider {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            outline: none;
            margin-bottom: 4px;
        }

        .height-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .height-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: none;
        }

        .height-buttons {
            display: flex;
            justify-content: space-between;
            gap: 4px;
        }

        .btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.2s ease;
            flex: 1;
        }

        .btn-small:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .settings-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-label {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 8px;
        }

        .mode-buttons {
            display: flex;
            gap: 5px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            background: rgba(255,255,255,0.1);
            color: #ccc;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .mode-btn.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 2px 8px rgba(76,175,80,0.3);
        }

        .sensitivity-control,
        .threshold-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sensitivity-control input[type="range"],
        .threshold-control input[type="range"] {
            flex: 1;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            outline: none;
        }

        .sensitivity-control input[type="range"]::-webkit-slider-thumb,
        .threshold-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
        }

        .setting-hint {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
            font-style: italic;
        }

        .sensitivity-value,
        .threshold-value {
            min-width: 35px;
            font-weight: bold;
            color: #fff;
            font-size: 0.85rem;
        }

        .auto-status {
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(244,67,54,0.8);
            display: inline-block;
        }

        .auto-status.active {
            background: rgba(76,175,80,0.8);
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .pressure-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .pressure-grid {
                max-width: 100%;
            }
            
            .pressure-cell {
                width: 15px;
                height: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ™ºèƒ½åºŠå«å¯è§†åŒ–ç³»ç»Ÿ</h1>
            <div class="status-bar">
                <div class="status-item" id="connectionStatus">
                    <span id="statusText">è¿æ¥ä¸­...</span>
                </div>
                <div class="status-item">
                    <span id="currentTime">--:--:--</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="pressure-section">
                <div class="matrix-header">
                    <h2 class="section-title">è¾“å…¥å‹åŠ›çŸ©é˜µ (1040ä¸ªä¼ æ„Ÿå™¨æ•°å€¼)</h2>
                    <button class="toggle-matrix-btn" onclick="togglePressureMatrix()" id="matrixToggleBtn">
                        <span class="toggle-icon">â–¼</span>
                        <span class="toggle-text">æ”¶èµ·</span>
                    </button>
                </div>
                <div class="pressure-matrix-display" id="pressureMatrixContainer">
                    <textarea id="pressureMatrix" readonly style="width: 100%; height: 900px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 15px; font-family: monospace; font-size: 11px; resize: none; backdrop-filter: blur(10px); line-height: 1.4;"></textarea>
                </div>
                
                <h2 class="section-title" style="margin-top: 25px;">å‹åŠ›ä¼ æ„Ÿå™¨çƒ­åŠ›å›¾ (40Ã—26)</h2>
                <div class="pressure-grid" id="pressureGrid"></div>
                <div class="pressure-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #000033;"></div>
                        <span>0</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0000ff;"></div>
                        <span>14</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0066ff;"></div>
                        <span>28</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ffff;"></div>
                        <span>42</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff99;"></div>
                        <span>56</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff00;"></div>
                        <span>70</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #99ff00;"></div>
                        <span>84</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffff00;"></div>
                        <span>98</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff9900;"></div>
                        <span>112</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff3300;"></div>
                        <span>126</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff0000;"></div>
                        <span>140+</span>
                    </div>
                </div>
            </div>

            <div class="metrics-section">
                <h2 class="section-title">å®æ—¶ç›‘æµ‹æŒ‡æ ‡</h2>
                
                <div class="posture-display">
                    <div class="posture-icon" id="postureIcon">ğŸ˜´</div>
                    <div class="posture-text" id="postureText">æ— äºº</div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">å¹³å‡å‹åŠ›</div>
                    <div class="metric-value" id="avgPressure">0.00</div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">å‹åŠ›æŒ‡æ•° (PI)</div>
                    <div class="metric-value" id="pressureIndex">0</div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">æ¥è§¦é¢æŒ‡æ•°</div>
                    <div class="metric-value" id="contactIndex">0%</div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">æœ€å¤§å‹åŠ›å€¼</div>
                    <div class="metric-value" id="maxPressure">0</div>
                </div>
                
                <!-- æ™ºèƒ½è°ƒèŠ‚è®¾ç½®é¢æ¿ -->
                <div class="settings-panel">
                    <h3 class="section-title" style="font-size: 1.2rem; margin-bottom: 15px;">æ™ºèƒ½è®¾ç½®</h3>
                    
                    <div class="setting-item">
                        <div class="setting-label">æ”¯æ’‘æ¨¡å¼</div>
                        <div class="mode-buttons">
                            <button class="mode-btn" onclick="setSupportMode('soft')">è½¯</button>
                            <button class="mode-btn active" onclick="setSupportMode('balanced')">å¹³è¡¡</button>
                            <button class="mode-btn" onclick="setSupportMode('firm')">ç¡¬</button>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">å‹åŠ›æ•æ„Ÿåº¦</div>
                        <div class="sensitivity-control">
                            <input type="range" id="sensitivitySlider" min="0.1" max="1.0" step="0.1" value="0.7" 
                                   onchange="setSensitivity(this.value)">
                            <span class="sensitivity-value" id="sensitivityValue">70%</span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">æ¥è§¦å‹åŠ›é˜ˆå€¼</div>
                        <div class="threshold-control">
                            <input type="range" id="thresholdSlider" min="0" max="20" step="1" value="5" 
                                   onchange="setPressureThreshold(this.value)">
                            <span class="threshold-value" id="thresholdValue">5</span>
                        </div>
                        <div class="setting-hint">è¶…è¿‡æ­¤é˜ˆå€¼çš„å‹åŠ›æ‰è®¤ä¸ºæ˜¯æ¥è§¦</div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">è‡ªåŠ¨è°ƒèŠ‚çŠ¶æ€</div>
                        <div class="auto-status" id="autoStatus">å…³é—­</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="airbag-control">
            <h2 class="section-title">æ°”å›Šæ§åˆ¶é¢æ¿</h2>
            <div class="airbag-grid" id="airbagGrid">
                <!-- æ°”å›Šæ§åˆ¶é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="control-buttons">
                <button class="btn" onclick="sendAirbagCommand('open_all')">å…¨éƒ¨ä¸­ç­‰é«˜åº¦</button>
                <button class="btn btn-secondary" onclick="sendAirbagCommand('close_all')">å…¨éƒ¨å¤ä½</button>
                <button class="btn" onclick="enableAutoMode()">æ™ºèƒ½è°ƒèŠ‚</button>
            </div>
        </div>
    </div>

    <script>
        class MattressVisualizer {
            constructor() {
                this.ws = null;
                this.currentData = null;
                this.airbagStates = {}; // 34ä¸ªæ°”å›ŠçŠ¶æ€ï¼Œä½¿ç”¨IDä½œä¸ºkey
                this.airbagHeights = {}; // 34ä¸ªæ°”å›Šé«˜åº¦(0-100%)
                this.autoMode = false; // è‡ªåŠ¨è°ƒèŠ‚æ¨¡å¼
                this.supportMode = 'balanced'; // æ”¯æ’‘æ¨¡å¼ï¼šsoft/balanced/firm
                this.pressureSensitivity = 0.7; // å‹åŠ›æ•æ„Ÿåº¦(0.1-1.0)
                this.pressureThreshold = 5; // æ¥è§¦å‹åŠ›é˜ˆå€¼(0-20)
                this.matrixExpanded = true; // çŸ©é˜µæ˜¾ç¤ºçŠ¶æ€
                this.initAirbagMappings();
                this.init();
            }

            initAirbagMappings() {
                // åŸºäº40x26ä¼ æ„Ÿå™¨ç½‘æ ¼çš„æ°”å›ŠåŒºåŸŸæ˜ å°„(è¡Œ,åˆ—åæ ‡èŒƒå›´)
                // åæ ‡ç³»ï¼š(0,0)åœ¨å·¦ä¸Šè§’ï¼Œè¡Œä»ä¸Šåˆ°ä¸‹ï¼Œåˆ—ä»å·¦åˆ°å³
                this.airbagRegions = {
                    // ç»¿è‰²çŸ©å½¢åŒºåŸŸ - å¤§å‹æ°”å›Š
                    40: { rows: [0, 4], cols: [2, 23], type: 'rectangle' },    // å¤´éƒ¨åŒºåŸŸ
                    41: { rows: [5, 9], cols: [2, 23], type: 'rectangle' },    // é¢ˆè‚©åŒºåŸŸ  
                    42: { rows: [10, 14], cols: [2, 23], type: 'rectangle' }, // ä¸ŠèƒŒåŒºåŸŸ
                    
                    // ç»¿è‰²åœ†å½¢åŒºåŸŸ - ä¸­å¤®æ”¯æ’‘æ°”å›Š
                    32: { rows: [15, 18], cols: [0, 3], type: 'circle' },
                    33: { rows: [15, 18], cols: [4, 7], type: 'circle' },
                    34: { rows: [15, 18], cols: [8, 11], type: 'circle' },
                    35: { rows: [15, 18], cols: [12, 15], type: 'circle' },
                    43: { rows: [15, 18], cols: [16, 19], type: 'circle' },
                    
                    24: { rows: [19, 22], cols: [0, 3], type: 'circle' },
                    25: { rows: [19, 22], cols: [4, 7], type: 'circle' },
                    26: { rows: [19, 22], cols: [8, 11], type: 'circle' },
                    27: { rows: [19, 22], cols: [12, 15], type: 'circle' },
                    
                    36: { rows: [23, 26], cols: [0, 3], type: 'circle' },
                    37: { rows: [23, 26], cols: [4, 7], type: 'circle' },
                    38: { rows: [23, 26], cols: [8, 11], type: 'circle' },
                    39: { rows: [23, 26], cols: [12, 15], type: 'circle' },
                    
                    28: { rows: [27, 30], cols: [0, 3], type: 'circle' },
                    29: { rows: [27, 30], cols: [4, 7], type: 'circle' },
                    30: { rows: [27, 30], cols: [8, 11], type: 'circle' },
                    31: { rows: [27, 30], cols: [12, 15], type: 'circle' },
                    
                    20: { rows: [31, 34], cols: [0, 3], type: 'circle' },
                    21: { rows: [31, 34], cols: [4, 7], type: 'circle' },
                    22: { rows: [31, 34], cols: [8, 11], type: 'circle' },
                    23: { rows: [31, 34], cols: [12, 15], type: 'circle' },
                    
                    // çº¢è‰²åœ†å½¢åŒºåŸŸ - ä¾§è¾¹æ”¯æ’‘æ°”å›Š
                    14: { rows: [15, 18], cols: [20, 23], type: 'circle' },
                    4:  { rows: [19, 22], cols: [20, 23], type: 'circle' },
                    5:  { rows: [19, 22], cols: [24, 25], type: 'circle' },
                    16: { rows: [23, 26], cols: [20, 23], type: 'circle' },
                    17: { rows: [23, 26], cols: [24, 25], type: 'circle' },
                    8:  { rows: [27, 30], cols: [20, 23], type: 'circle' },
                    9:  { rows: [27, 30], cols: [24, 25], type: 'circle' },
                    0:  { rows: [31, 34], cols: [20, 23], type: 'circle' },
                    1:  { rows: [31, 34], cols: [24, 25], type: 'circle' },
                    
                    // çº¢è‰²çŸ©å½¢åŒºåŸŸ - åº•éƒ¨æ°”å›Š
                    12: { rows: [35, 39], cols: [8, 17], type: 'rectangle' }  // è…¿éƒ¨åŒºåŸŸ
                };

                // åˆå§‹åŒ–æ‰€æœ‰æ°”å›ŠçŠ¶æ€
                Object.keys(this.airbagRegions).forEach(id => {
                    this.airbagStates[id] = false;
                    this.airbagHeights[id] = 0; // åˆå§‹é«˜åº¦ä¸º0%
                });
            }

            init() {
                this.connectWebSocket();
                this.createPressureGrid();
                this.createAirbagGrid();
                this.initSettingsPanel();
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);
            }

            connectWebSocket() {
                this.ws = new WebSocket('ws://127.0.0.1:8000');
                
                this.ws.onopen = () => {
                    this.updateConnectionStatus(true);
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                };

                this.ws.onmessage = (event) => {
                    try {
                        this.currentData = JSON.parse(event.data);
                        this.updateVisualization();
                    } catch (error) {
                        console.error('æ•°æ®è§£æé”™è¯¯:', error);
                    }
                };

                this.ws.onclose = () => {
                    this.updateConnectionStatus(false);
                    console.log('WebSocketè¿æ¥å·²æ–­å¼€');
                    // 5ç§’åå°è¯•é‡è¿
                    setTimeout(() => this.connectWebSocket(), 5000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    this.updateConnectionStatus(false);
                };
            }

            createPressureGrid() {
                const grid = document.getElementById('pressureGrid');
                grid.innerHTML = '';
                
                // åˆ›å»º40x26=1040ä¸ªå‹åŠ›ä¼ æ„Ÿå™¨æ ¼å­
                for (let i = 0; i < 1040; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'pressure-cell';
                    cell.id = `cell-${i}`;
                    grid.appendChild(cell);
                }
            }

            createAirbagGrid() {
                const grid = document.getElementById('airbagGrid');
                grid.innerHTML = '';
                
                // è·å–æ‰€æœ‰æ°”å›ŠIDå¹¶æ’åº
                const airbagIds = Object.keys(this.airbagRegions).map(id => parseInt(id)).sort((a, b) => a - b);
                
                airbagIds.forEach(id => {
                    const region = this.airbagRegions[id];
                    const item = document.createElement('div');
                    item.className = 'airbag-item';
                    item.id = `airbag-${id}`;
                    
                    // æ ¹æ®æ°”å›Šç±»å‹è®¾ç½®ä¸åŒæ ·å¼
                    const typeClass = region.type === 'rectangle' ? 'airbag-rectangle' : 'airbag-circle';
                    item.classList.add(typeClass);
                    
                    item.innerHTML = `
                        <div class="airbag-number">æ°”å›Š ${id}</div>
                        <div class="airbag-height-display">é«˜åº¦: <span class="height-value">0%</span></div>
                        <div class="airbag-controls">
                            <input type="range" class="height-slider" min="0" max="100" value="0" 
                                   onchange="adjustAirbagHeight(${id}, this.value)">
                            <div class="height-buttons">
                                <button class="btn-small" onclick="setAirbagHeight(${id}, 0)">å…³</button>
                                <button class="btn-small" onclick="setAirbagHeight(${id}, 50)">ä¸­</button>
                                <button class="btn-small" onclick="setAirbagHeight(${id}, 100)">é«˜</button>
                            </div>
                        </div>
                    `;
                    
                    grid.appendChild(item);
                });
            }

            updateVisualization() {
                if (!this.currentData) return;

                // æ›´æ–°å‹åŠ›çŸ©é˜µæ˜¾ç¤º
                this.updatePressureMatrix();
                
                // æ›´æ–°å‹åŠ›ä¼ æ„Ÿå™¨çƒ­åŠ›å›¾
                this.updatePressureGrid();
                
                // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
                this.updateMetrics();
                
                // æ›´æ–°ç¡çœ å§¿æ€
                this.updatePosture();
                
                // å¦‚æœå¯ç”¨è‡ªåŠ¨æ¨¡å¼ï¼Œæ‰§è¡Œæ™ºèƒ½è°ƒèŠ‚
                if (this.autoMode) {
                    this.performAutoAdjustment();
                }
            }

            updatePressureMatrix() {
                if (!this.currentData.pressure) return;
                
                let pressureArray;
                try {
                    pressureArray = JSON.parse(this.currentData.pressure);
                } catch (error) {
                    console.error('å‹åŠ›æ•°æ®è§£æé”™è¯¯:', error);
                    return;
                }
                
                if (pressureArray.length !== 1040) {
                    console.error('å‹åŠ›æ•°æ®é•¿åº¦é”™è¯¯ï¼ŒæœŸæœ›1040ä¸ªå€¼');
                    return;
                }
                
                // æ ¼å¼åŒ–å‹åŠ›çŸ©é˜µæ˜¾ç¤ºï¼Œæ¯è¡Œ26ä¸ªå€¼ï¼Œå…±40è¡Œ
                let matrixText = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
                matrixText += 'â•‘        æ™ºèƒ½åºŠå«å‹åŠ›ä¼ æ„Ÿå™¨çŸ©é˜µ (40Ã—26)       â•‘\n';
                matrixText += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
                
                for (let row = 0; row < 40; row++) {
                    let rowData = [];
                    for (let col = 0; col < 26; col++) {
                        const index = row * 26 + col;
                        const pressure = pressureArray[index];
                        // æ ¼å¼åŒ–ä¸º3ä½æ•°ï¼Œä½¿ç”¨å³å¯¹é½
                        rowData.push(pressure.toString().padStart(3, ' '));
                    }
                    matrixText += `${(row + 1).toString().padStart(2, '0')}: ${rowData.join(' ')}\n`;
                }
                
                // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
                const totalSensors = pressureArray.length;
                const basicActiveSensors = pressureArray.filter(p => p > 0).length;
                const thresholdActiveSensors = pressureArray.filter(p => p > this.pressureThreshold).length;
                const maxPressure = Math.max(...pressureArray);
                const avgPressure = (pressureArray.reduce((sum, p) => sum + p, 0) / totalSensors).toFixed(2);
                
                matrixText += '\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n';
                matrixText += 'â”‚                       ç»Ÿè®¡ä¿¡æ¯                       â”‚\n';
                matrixText += 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n';
                matrixText += `â”‚ æ€»ä¼ æ„Ÿå™¨æ•°é‡: ${totalSensors.toString().padEnd(35)} â”‚\n`;
                matrixText += `â”‚ æœ‰å‹åŠ›ä¼ æ„Ÿå™¨: ${basicActiveSensors.toString().padEnd(34)} â”‚\n`;
                matrixText += `â”‚ è¶…é˜ˆå€¼(>${this.pressureThreshold})ä¼ æ„Ÿå™¨: ${thresholdActiveSensors.toString().padEnd(26)} â”‚\n`;
                matrixText += `â”‚ æœ€å¤§å‹åŠ›å€¼: ${maxPressure.toString().padEnd(36)} â”‚\n`;
                matrixText += `â”‚ å¹³å‡å‹åŠ›å€¼: ${avgPressure.toString().padEnd(36)} â”‚\n`;
                matrixText += `â”‚ æ¥è§¦é¢æŒ‡æ•°(é˜ˆå€¼=${this.pressureThreshold}): ${(thresholdActiveSensors / totalSensors * 100).toFixed(1)}%`.padEnd(68) + ' â”‚\n';
                matrixText += 'â”‚ æ¥è§¦é¢è¦†ç›–ç‡: ' + `${((thresholdActiveSensors / 1040) * 100).toFixed(2)}%`.padEnd(37) + ' â”‚\n';
                matrixText += 'â”‚ å‹åŠ›åˆ†å¸ƒå¯†åº¦: ' + `${((basicActiveSensors / 1040) * 100).toFixed(2)}%`.padEnd(37) + ' â”‚\n';
                matrixText += 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜';
                
                const matrixElement = document.getElementById('pressureMatrix');
                if (matrixElement) {
                    matrixElement.value = matrixText;
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨
                    matrixElement.scrollTop = 0;
                }
            }

            updatePressureGrid() {
                if (!this.currentData.pressure) return;

                let pressureArray;
                try {
                    pressureArray = JSON.parse(this.currentData.pressure);
                } catch (error) {
                    console.error('å‹åŠ›æ•°æ®è§£æé”™è¯¯:', error);
                    return;
                }

                if (pressureArray.length !== 1040) {
                    console.error('å‹åŠ›æ•°æ®é•¿åº¦é”™è¯¯ï¼ŒæœŸæœ›1040ä¸ªå€¼');
                    return;
                }

                // æ‰¾å‡ºæœ€å¤§å‹åŠ›å€¼ç”¨äºå½’ä¸€åŒ–
                const maxPressure = Math.max(...pressureArray);
                const maxPressureElement = document.getElementById('maxPressure');
                if (maxPressureElement) {
                    maxPressureElement.textContent = maxPressure;
                }

                // æ›´æ–°æ¯ä¸ªä¼ æ„Ÿå™¨æ ¼å­çš„é¢œè‰²
                pressureArray.forEach((pressure, index) => {
                    const cell = document.getElementById(`cell-${index}`);
                    if (cell) {
                        cell.style.backgroundColor = this.getPressureColor(pressure);
                        cell.title = `ä½ç½®: ${index}, å‹åŠ›: ${pressure}`;
                    }
                });
            }

            getPressureColor(pressure) {
                // é«˜ç²¾åº¦è¿ç»­è‰²å½©æ˜ å°„ï¼Œæ”¯æŒ0-140å‹åŠ›å€¼èŒƒå›´
                if (pressure <= 0) return '#000033'; // æ·±è“è‰² - æ— å‹åŠ›
                
                // å°†å‹åŠ›å€¼æ˜ å°„åˆ°0-1èŒƒå›´ï¼Œæœ€å¤§å€¼è®¾ä¸º140
                const normalized = Math.min(pressure / 140, 1.0);
                
                // å®šä¹‰è‰²å½©æ¢¯åº¦ç‚¹ (HSVè‰²å½©ç©ºé—´)
                const colorStops = [
                    {pos: 0.0,  h: 240, s: 100, v: 20},   // æ·±è“
                    {pos: 0.1,  h: 240, s: 100, v: 50},   // è“è‰²
                    {pos: 0.2,  h: 210, s: 100, v: 70},   // æµ…è“
                    {pos: 0.3,  h: 180, s: 100, v: 80},   // é’è‰²
                    {pos: 0.4,  h: 150, s: 100, v: 85},   // é’ç»¿
                    {pos: 0.5,  h: 120, s: 100, v: 90},   // ç»¿è‰²
                    {pos: 0.6,  h: 90,  s: 100, v: 95},   // é»„ç»¿
                    {pos: 0.7,  h: 60,  s: 100, v: 100},  // é»„è‰²
                    {pos: 0.8,  h: 30,  s: 100, v: 100},  // æ©™è‰²
                    {pos: 0.9,  h: 15,  s: 100, v: 100},  // æ©˜çº¢
                    {pos: 1.0,  h: 0,   s: 100, v: 100}   // çº¯çº¢
                ];
                
                // æ‰¾åˆ°å½“å‰ä½ç½®åœ¨å“ªä¸¤ä¸ªè‰²å½©ç‚¹ä¹‹é—´
                let lowerStop = colorStops[0];
                let upperStop = colorStops[colorStops.length - 1];
                
                for (let i = 0; i < colorStops.length - 1; i++) {
                    if (normalized >= colorStops[i].pos && normalized <= colorStops[i + 1].pos) {
                        lowerStop = colorStops[i];
                        upperStop = colorStops[i + 1];
                        break;
                    }
                }
                
                // åœ¨ä¸¤ä¸ªè‰²å½©ç‚¹ä¹‹é—´è¿›è¡Œæ’å€¼
                const range = upperStop.pos - lowerStop.pos;
                const t = range > 0 ? (normalized - lowerStop.pos) / range : 0;
                
                const h = lowerStop.h + (upperStop.h - lowerStop.h) * t;
                const s = lowerStop.s + (upperStop.s - lowerStop.s) * t;
                const v = lowerStop.v + (upperStop.v - lowerStop.v) * t;
                
                // å°†HSVè½¬æ¢ä¸ºRGB
                return this.hsvToRgb(h, s, v);
            }

            hsvToRgb(h, s, v) {
                h = h / 360;
                s = s / 100;
                v = v / 100;
                
                const c = v * s;
                const x = c * (1 - Math.abs((h * 6) % 2 - 1));
                const m = v - c;
                
                let r, g, b;
                
                if (h < 1/6) {
                    r = c; g = x; b = 0;
                } else if (h < 2/6) {
                    r = x; g = c; b = 0;
                } else if (h < 3/6) {
                    r = 0; g = c; b = x;
                } else if (h < 4/6) {
                    r = 0; g = x; b = c;
                } else if (h < 5/6) {
                    r = x; g = 0; b = c;
                } else {
                    r = c; g = 0; b = x;
                }
                
                r = Math.round((r + m) * 255);
                g = Math.round((g + m) * 255);
                b = Math.round((b + m) * 255);
                
                return `rgb(${r}, ${g}, ${b})`;
            }

            calculateAirbagPressures(pressureArray) {
                // è®¡ç®—æ¯ä¸ªæ°”å›ŠåŒºåŸŸçš„å¹³å‡å‹åŠ›
                const airbagPressures = {};
                
                Object.keys(this.airbagRegions).forEach(airbagId => {
                    const region = this.airbagRegions[airbagId];
                    let totalPressure = 0;
                    let sensorCount = 0;
                    
                    // éå†è¯¥æ°”å›Šè¦†ç›–çš„ä¼ æ„Ÿå™¨åŒºåŸŸ
                    for (let row = region.rows[0]; row <= region.rows[1]; row++) {
                        for (let col = region.cols[0]; col <= region.cols[1]; col++) {
                            // è½¬æ¢ä¸ºä¼ æ„Ÿå™¨æ•°ç»„çš„ç´¢å¼• (40è¡Œx26åˆ—)
                            const sensorIndex = row * 26 + col;
                            
                            if (sensorIndex >= 0 && sensorIndex < pressureArray.length) {
                                // å¯¹äºåœ†å½¢æ°”å›Šï¼Œåº”ç”¨ç®€å•çš„åœ†å½¢é®ç½©
                                if (region.type === 'circle') {
                                    const centerRow = (region.rows[0] + region.rows[1]) / 2;
                                    const centerCol = (region.cols[0] + region.cols[1]) / 2;
                                    const radiusRow = (region.rows[1] - region.rows[0]) / 2;
                                    const radiusCol = (region.cols[1] - region.cols[0]) / 2;
                                    
                                    const distanceRow = Math.abs(row - centerRow) / radiusRow;
                                    const distanceCol = Math.abs(col - centerCol) / radiusCol;
                                    
                                    // æ¤­åœ†å½¢åŒºåŸŸæ£€æµ‹
                                    if (distanceRow * distanceRow + distanceCol * distanceCol <= 1) {
                                        totalPressure += pressureArray[sensorIndex];
                                        sensorCount++;
                                    }
                                } else {
                                    // çŸ©å½¢åŒºåŸŸï¼Œç›´æ¥åŒ…å«æ‰€æœ‰ä¼ æ„Ÿå™¨
                                    totalPressure += pressureArray[sensorIndex];
                                    sensorCount++;
                                }
                            }
                        }
                    }
                    
                    // è®¡ç®—å¹³å‡å‹åŠ›
                    airbagPressures[airbagId] = sensorCount > 0 ? totalPressure / sensorCount : 0;
                });
                
                return airbagPressures;
            }

            calculateOptimalAirbagHeights(airbagPressures) {
                // æ™ºèƒ½å‹åŠ›-é«˜åº¦æ˜ å°„ç®—æ³•
                const optimalHeights = {};
                
                // å®šä¹‰ä¸åŒèº«ä½“éƒ¨ä½çš„æ”¯æ’‘ç­–ç•¥
                const bodyRegionStrategies = {
                    // å¤´éƒ¨åŒºåŸŸ(40,41,42) - éœ€è¦è½»åº¦æ”¯æ’‘
                    head: { airbags: [40, 41, 42], baseHeight: 20, pressureMultiplier: 0.3 },
                    // è‚©èƒŒåŒºåŸŸ - éœ€è¦ä¸­ç­‰æ”¯æ’‘
                    shoulder: { airbags: [32, 33, 34, 35, 43], baseHeight: 40, pressureMultiplier: 0.5 },
                    // è…°éƒ¨åŒºåŸŸ - éœ€è¦å¼ºåŠ›æ”¯æ’‘
                    waist: { airbags: [24, 25, 26, 27], baseHeight: 60, pressureMultiplier: 0.8 },
                    // èƒŒéƒ¨ä¸­æ®µ
                    back: { airbags: [36, 37, 38, 39], baseHeight: 50, pressureMultiplier: 0.6 },
                    // ä¸‹èƒŒéƒ¨
                    lowerBack: { airbags: [28, 29, 30, 31], baseHeight: 55, pressureMultiplier: 0.7 },
                    // è…¿éƒ¨åŒºåŸŸ
                    legs: { airbags: [20, 21, 22, 23, 12], baseHeight: 30, pressureMultiplier: 0.4 },
                    // ä¾§è¾¹æ”¯æ’‘
                    side: { airbags: [14, 4, 5, 16, 17, 8, 9, 0, 1], baseHeight: 35, pressureMultiplier: 0.4 }
                };

                // æ”¯æ’‘æ¨¡å¼è°ƒèŠ‚ç³»æ•°
                const modeMultipliers = {
                    soft: 0.7,
                    balanced: 1.0,
                    firm: 1.3
                };

                const modeMultiplier = modeMultipliers[this.supportMode] || 1.0;

                // ä¸ºæ¯ä¸ªæ°”å›Šè®¡ç®—æœ€ä½³é«˜åº¦
                Object.keys(airbagPressures).forEach(airbagId => {
                    const pressure = airbagPressures[airbagId];
                    const id = parseInt(airbagId);
                    
                    // æ‰¾åˆ°è¯¥æ°”å›Šå±äºå“ªä¸ªèº«ä½“åŒºåŸŸ
                    let strategy = null;
                    for (const [regionName, regionStrategy] of Object.entries(bodyRegionStrategies)) {
                        if (regionStrategy.airbags.includes(id)) {
                            strategy = regionStrategy;
                            break;
                        }
                    }

                    if (strategy) {
                        // è®¡ç®—åŸºç¡€é«˜åº¦
                        let targetHeight = strategy.baseHeight;
                        
                        // æ ¹æ®å‹åŠ›è°ƒæ•´é«˜åº¦
                        if (pressure > 0) {
                            // å‹åŠ›è¶Šå¤§ï¼Œéœ€è¦æ›´å¤šæ”¯æ’‘
                            const pressureAdjustment = (pressure / 50) * strategy.pressureMultiplier * 100;
                            targetHeight += pressureAdjustment * this.pressureSensitivity;
                        } else {
                            // æ— å‹åŠ›åŒºåŸŸé™ä½é«˜åº¦
                            targetHeight *= 0.3;
                        }
                        
                        // åº”ç”¨æ”¯æ’‘æ¨¡å¼è°ƒèŠ‚
                        targetHeight *= modeMultiplier;
                        
                        // é™åˆ¶åœ¨åˆç†èŒƒå›´å†…
                        targetHeight = Math.max(0, Math.min(100, Math.round(targetHeight)));
                        
                        optimalHeights[airbagId] = targetHeight;
                    } else {
                        // æœªåˆ†ç±»çš„æ°”å›Šä½¿ç”¨é»˜è®¤ç­–ç•¥
                        const defaultHeight = pressure > 0 ? Math.min(50, pressure * 2) : 0;
                        optimalHeights[airbagId] = Math.round(defaultHeight * modeMultiplier);
                    }
                });

                return optimalHeights;
            }

            enableAutoMode() {
                this.autoMode = !this.autoMode;
                const button = document.querySelector('button[onclick="enableAutoMode()"]');
                if (button) {
                    button.textContent = this.autoMode ? 'åœæ­¢æ™ºèƒ½è°ƒèŠ‚' : 'æ™ºèƒ½è°ƒèŠ‚';
                    button.className = this.autoMode ? 'btn btn-secondary' : 'btn';
                }
                
                // æ›´æ–°è‡ªåŠ¨è°ƒèŠ‚çŠ¶æ€æ˜¾ç¤º
                this.updateAutoStatus();
                
                if (this.autoMode && this.currentData) {
                    this.performAutoAdjustment();
                }
                
                console.log(`è‡ªåŠ¨è°ƒèŠ‚æ¨¡å¼: ${this.autoMode ? 'å¼€å¯' : 'å…³é—­'}`);
            }

            setSupportMode(mode) {
                this.supportMode = mode;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.querySelector(`button[onclick="setSupportMode('${mode}')"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                console.log(`æ”¯æ’‘æ¨¡å¼åˆ‡æ¢ä¸º: ${mode}`);
                
                // å¦‚æœæ­£åœ¨è‡ªåŠ¨æ¨¡å¼ï¼Œç«‹å³åº”ç”¨æ–°è®¾ç½®
                if (this.autoMode && this.currentData) {
                    this.performAutoAdjustment();
                }
            }

            setSensitivity(value) {
                this.pressureSensitivity = parseFloat(value);
                
                // æ›´æ–°æ˜¾ç¤ºå€¼
                const sensitivityValue = document.getElementById('sensitivityValue');
                if (sensitivityValue) {
                    sensitivityValue.textContent = `${Math.round(this.pressureSensitivity * 100)}%`;
                }
                
                console.log(`å‹åŠ›æ•æ„Ÿåº¦è°ƒæ•´ä¸º: ${this.pressureSensitivity}`);
                
                // å¦‚æœæ­£åœ¨è‡ªåŠ¨æ¨¡å¼ï¼Œç«‹å³åº”ç”¨æ–°è®¾ç½®
                if (this.autoMode && this.currentData) {
                    this.performAutoAdjustment();
                }
            }

            setPressureThreshold(value) {
                this.pressureThreshold = parseInt(value);
                
                // æ›´æ–°æ˜¾ç¤ºå€¼
                const thresholdValue = document.getElementById('thresholdValue');
                if (thresholdValue) {
                    thresholdValue.textContent = this.pressureThreshold;
                }
                
                console.log(`æ¥è§¦å‹åŠ›é˜ˆå€¼è°ƒæ•´ä¸º: ${this.pressureThreshold}`);
                
                // ç«‹å³é‡æ–°è®¡ç®—æ¥è§¦é¢æŒ‡æ•°
                if (this.currentData) {
                    this.updateMetrics();
                    this.updatePressureMatrix();
                }
            }

            togglePressureMatrix() {
                this.matrixExpanded = !this.matrixExpanded;
                
                const container = document.getElementById('pressureMatrixContainer');
                const toggleBtn = document.getElementById('matrixToggleBtn');
                const toggleIcon = toggleBtn.querySelector('.toggle-icon');
                const toggleText = toggleBtn.querySelector('.toggle-text');
                
                if (this.matrixExpanded) {
                    // å±•å¼€çŠ¶æ€
                    container.classList.remove('collapsed');
                    toggleBtn.classList.remove('collapsed');
                    toggleIcon.textContent = 'â–¼';
                    toggleText.textContent = 'æ”¶èµ·';
                } else {
                    // æ”¶èµ·çŠ¶æ€
                    container.classList.add('collapsed');
                    toggleBtn.classList.add('collapsed');
                    toggleIcon.textContent = 'â–¶';
                    toggleText.textContent = 'å±•å¼€';
                }
                
                console.log(`å‹åŠ›çŸ©é˜µæ˜¾ç¤ºçŠ¶æ€: ${this.matrixExpanded ? 'å±•å¼€' : 'æ”¶èµ·'}`);
            }

            updateAutoStatus() {
                const autoStatus = document.getElementById('autoStatus');
                if (autoStatus) {
                    autoStatus.textContent = this.autoMode ? 'å¼€å¯' : 'å…³é—­';
                    autoStatus.className = this.autoMode ? 'auto-status active' : 'auto-status';
                }
            }

            initSettingsPanel() {
                // è®¾ç½®é»˜è®¤æ”¯æ’‘æ¨¡å¼æŒ‰é’®çŠ¶æ€
                const balancedBtn = document.querySelector("button[onclick=\"setSupportMode('balanced')\"]");
                if (balancedBtn) {
                    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                    balancedBtn.classList.add('active');
                }
                
                // è®¾ç½®é»˜è®¤æ•æ„Ÿåº¦æ˜¾ç¤º
                const sensitivityValue = document.getElementById('sensitivityValue');
                if (sensitivityValue) {
                    sensitivityValue.textContent = `${Math.round(this.pressureSensitivity * 100)}%`;
                }
                
                // è®¾ç½®é»˜è®¤é˜ˆå€¼æ˜¾ç¤º
                const thresholdValue = document.getElementById('thresholdValue');
                if (thresholdValue) {
                    thresholdValue.textContent = this.pressureThreshold;
                }
                
                // åˆå§‹åŒ–è‡ªåŠ¨çŠ¶æ€æ˜¾ç¤º
                this.updateAutoStatus();
            }

            performAutoAdjustment() {
                if (!this.autoMode || !this.currentData) return;

                try {
                    const pressureArray = JSON.parse(this.currentData.pressure);
                    const airbagPressures = this.calculateAirbagPressures(pressureArray);
                    const optimalHeights = this.calculateOptimalAirbagHeights(airbagPressures);
                    
                    // å¹³æ»‘è°ƒèŠ‚åˆ°ç›®æ ‡é«˜åº¦ï¼Œé¿å…çªç„¶å˜åŒ–
                    Object.keys(optimalHeights).forEach(airbagId => {
                        const targetHeight = optimalHeights[airbagId];
                        const currentHeight = this.airbagHeights[airbagId] || 0;
                        
                        // é€æ­¥è°ƒèŠ‚åˆ°ç›®æ ‡é«˜åº¦
                        const heightDiff = targetHeight - currentHeight;
                        const adjustStep = Math.sign(heightDiff) * Math.min(Math.abs(heightDiff), 5); // æ¯æ¬¡æœ€å¤šè°ƒèŠ‚5%
                        
                        const newHeight = currentHeight + adjustStep;
                        this.setAirbagHeight(airbagId, newHeight);
                    });
                    
                    console.log('æ‰§è¡Œæ™ºèƒ½è°ƒèŠ‚:', optimalHeights);
                } catch (error) {
                    console.error('æ™ºèƒ½è°ƒèŠ‚é”™è¯¯:', error);
                }
            }

            calculateRealTimeMetrics(pressureArray) {
                if (!pressureArray || pressureArray.length !== 1040) {
                    return {
                        avgPressure: 0,
                        pressureIndex: 0,
                        contactIndex: 0,
                        maxPressure: 0
                    };
                }
                
                // è®¡ç®—å¹³å‡å‹åŠ›
                const totalPressure = pressureArray.reduce((sum, pressure) => sum + pressure, 0);
                const avgPressure = totalPressure / 1040;
                
                // è®¡ç®—æœ€å¤§å‹åŠ›
                const maxPressure = Math.max(...pressureArray);
                
                // è®¡ç®—æ¥è§¦é¢æŒ‡æ•° (è¶…è¿‡é˜ˆå€¼çš„ä¼ æ„Ÿå™¨æ•°é‡ / æ€»ä¼ æ„Ÿå™¨æ•°é‡ * 100%)
                const activeSensors = pressureArray.filter(pressure => pressure > this.pressureThreshold).length;
                const contactIndex = (activeSensors / 1040) * 100;
                
                // è®¡ç®—å‹åŠ›æŒ‡æ•° (åŸºäºå‹åŠ›åˆ†å¸ƒå’Œå¼ºåº¦çš„ç»¼åˆæŒ‡æ ‡)
                // ä½¿ç”¨åŠ æƒå…¬å¼ï¼šè€ƒè™‘å‹åŠ›æ€»å’Œå’Œåˆ†å¸ƒå¯†åº¦
                const nonZeroPressures = pressureArray.filter(p => p > 0);
                let pressureIndex = 0;
                if (nonZeroPressures.length > 0) {
                    const avgNonZero = nonZeroPressures.reduce((sum, p) => sum + p, 0) / nonZeroPressures.length;
                    const distributionFactor = nonZeroPressures.length / 1040; // å‹åŠ›åˆ†å¸ƒå¯†åº¦
                    pressureIndex = avgNonZero * distributionFactor * 10; // ç¼©æ”¾ç³»æ•°
                }
                
                return {
                    avgPressure: parseFloat(avgPressure.toFixed(2)),
                    pressureIndex: parseFloat(pressureIndex.toFixed(2)), 
                    contactIndex: parseFloat(contactIndex.toFixed(1)),
                    maxPressure: maxPressure
                };
            }

            updateMetrics() {
                if (!this.currentData) return;

                // è·å–å‹åŠ›æ•°ç»„è¿›è¡Œå®æ—¶è®¡ç®—
                let pressureArray = [];
                try {
                    pressureArray = JSON.parse(this.currentData.pressure);
                } catch (error) {
                    console.error('å‹åŠ›æ•°æ®è§£æé”™è¯¯:', error);
                    return;
                }

                // è®¡ç®—å®æ—¶æŒ‡æ ‡
                const realTimeMetrics = this.calculateRealTimeMetrics(pressureArray);
                
                // æ›´æ–°ç•Œé¢æŒ‡æ ‡æ˜¾ç¤º
                const elements = {
                    avgPressure: realTimeMetrics.avgPressure.toFixed(2),
                    pressureIndex: realTimeMetrics.pressureIndex.toFixed(2),
                    contactIndex: realTimeMetrics.contactIndex.toFixed(1) + '%',
                    maxPressure: realTimeMetrics.maxPressure
                };

                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });
            }

            updatePosture() {
                if (!this.currentData) return;

                const postureIcon = document.getElementById('postureIcon');
                const postureText = document.getElementById('postureText');
                
                if (!postureIcon || !postureText) return;

                const posture = this.currentData.posture;
                
                switch (posture) {
                    case 'no':
                        postureIcon.textContent = 'ğŸ›ï¸';
                        postureText.textContent = 'æ— äºº';
                        break;
                    case 'supine':
                        postureIcon.textContent = 'ğŸ›Œ';
                        postureText.textContent = 'ä»°å§';
                        break;
                    case 'side':
                        postureIcon.textContent = 'ğŸ˜´';
                        postureText.textContent = 'ä¾§å§';
                        break;
                    default:
                        postureIcon.textContent = 'â“';
                        postureText.textContent = 'æœªçŸ¥';
                }
            }

            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusElement.className = 'status-item status-connected';
                    statusText.textContent = 'å·²è¿æ¥';
                } else {
                    statusElement.className = 'status-item status-disconnected';
                    statusText.textContent = 'è¿æ¥æ–­å¼€';
                }
            }

            updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = timeString;
                }
            }

            setAirbagHeight(id, height) {
                this.airbagHeights[id] = Math.max(0, Math.min(100, height));
                this.updateAirbagDisplay(id);
                this.sendAirbagCommand();
            }

            adjustAirbagHeight(id, height) {
                this.setAirbagHeight(id, parseInt(height));
            }

            updateAirbagDisplay(id) {
                const airbagElement = document.getElementById(`airbag-${id}`);
                const heightValueElement = airbagElement.querySelector('.height-value');
                const sliderElement = airbagElement.querySelector('.height-slider');
                
                if (heightValueElement) {
                    heightValueElement.textContent = `${this.airbagHeights[id]}%`;
                }
                
                if (sliderElement) {
                    sliderElement.value = this.airbagHeights[id];
                }
                
                // æ ¹æ®é«˜åº¦è°ƒæ•´è§†è§‰æ ·å¼
                const height = this.airbagHeights[id];
                if (height > 0) {
                    airbagElement.style.boxShadow = `0 0 ${height/10}px rgba(76,175,80,0.6)`;
                    airbagElement.style.background = `rgba(76,175,80,${0.2 + height/500})`;
                } else {
                    airbagElement.style.boxShadow = 'none';
                    const region = this.airbagRegions[id];
                    if (region.type === 'rectangle') {
                        airbagElement.style.background = 'rgba(76,175,80,0.2)';
                    } else {
                        airbagElement.style.background = 'rgba(33,150,243,0.2)';
                    }
                }
            }

            sendAirbagCommand(command = null) {
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    console.log('WebSocketæœªè¿æ¥');
                    return;
                }

                let airbagData = {};
                
                if (command === 'open_all') {
                    // å…¨éƒ¨å¼€å¯åˆ°50%é«˜åº¦
                    Object.keys(this.airbagRegions).forEach(id => {
                        this.airbagHeights[id] = 50;
                        airbagData[id] = 50;
                    });
                } else if (command === 'close_all') {
                    // å…¨éƒ¨å…³é—­åˆ°0%é«˜åº¦
                    Object.keys(this.airbagRegions).forEach(id => {
                        this.airbagHeights[id] = 0;
                        airbagData[id] = 0;
                    });
                } else {
                    // å‘é€å½“å‰æ‰€æœ‰æ°”å›Šé«˜åº¦
                    airbagData = {...this.airbagHeights};
                }

                const data = {
                    airbag_heights: JSON.stringify(airbagData),
                    time: "5"
                };

                this.ws.send(JSON.stringify(data));
                console.log('å‘é€æ°”å›Šé«˜åº¦æ§åˆ¶å‘½ä»¤:', data);

                // æ›´æ–°æ‰€æœ‰æ°”å›Šæ˜¾ç¤º
                Object.keys(this.airbagRegions).forEach(id => {
                    this.updateAirbagDisplay(id);
                });
            }
        }

        // å…¨å±€å‡½æ•°ä¾›æŒ‰é’®è°ƒç”¨
        let visualizer;

        function sendAirbagCommand(command) {
            if (visualizer) {
                visualizer.sendAirbagCommand(command);
            }
        }

        function setAirbagHeight(id, height) {
            if (visualizer) {
                visualizer.setAirbagHeight(id, height);
            }
        }

        function adjustAirbagHeight(id, height) {
            if (visualizer) {
                visualizer.adjustAirbagHeight(id, height);
            }
        }

        function enableAutoMode() {
            if (visualizer) {
                visualizer.enableAutoMode();
            }
        }

        function setSupportMode(mode) {
            if (visualizer) {
                visualizer.setSupportMode(mode);
            }
        }

        function setSensitivity(value) {
            if (visualizer) {
                visualizer.setSensitivity(value);
            }
        }

        function setPressureThreshold(value) {
            if (visualizer) {
                visualizer.setPressureThreshold(value);
            }
        }

        function togglePressureMatrix() {
            if (visualizer) {
                visualizer.togglePressureMatrix();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            visualizer = new MattressVisualizer();
        });
    </script>
</body>
</html>