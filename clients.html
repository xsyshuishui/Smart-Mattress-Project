<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能床垫可视化系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-item {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .status-connected {
            background: rgba(76,175,80,0.8);
        }

        .status-disconnected {
            background: rgba(244,67,54,0.8);
        }

        .main-content {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .pressure-section {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            overflow: visible;
        }
        
        .matrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .toggle-matrix-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-matrix-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
        }
        
        .toggle-matrix-btn.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .pressure-matrix-display {
            margin-bottom: 25px;
            transition: all 0.4s ease;
            overflow: hidden;
        }
        
        .pressure-matrix-display.collapsed {
            height: 0 !important;
            margin-bottom: 0;
            opacity: 0;
        }
        
        #pressureMatrix {
            font-weight: 500;
            letter-spacing: 0.5px;
            overflow: hidden;
            transition: opacity 0.3s ease;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .pressure-grid {
            display: grid;
            grid-template-columns: repeat(26, 1fr);
            gap: 1px;
            background: #333;
            padding: 10px;
            border-radius: 10px;
            max-width: 650px;
            margin: 0 auto;
        }

        .pressure-cell {
            width: 20px;
            height: 15px;
            background: #000;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .metrics-section {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .metric-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }

        .posture-display {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin: 20px 0;
        }

        .posture-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .posture-text {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .airbag-control {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            margin-top: 30px;
        }

        .airbag-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .airbag-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 120px;
        }

        .airbag-rectangle {
            border-color: #4CAF50;
            background: rgba(76,175,80,0.2);
        }

        .airbag-circle {
            border-color: #2196F3;
            background: rgba(33,150,243,0.2);
        }

        .airbag-number {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 6px;
            color: #fff;
        }

        .airbag-height-display {
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 8px;
        }

        .height-value {
            font-weight: bold;
            color: #fff;
        }

        .airbag-controls {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .height-slider {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            outline: none;
            margin-bottom: 4px;
        }

        .height-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .height-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: none;
        }

        .height-buttons {
            display: flex;
            justify-content: space-between;
            gap: 4px;
        }

        .btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.2s ease;
            flex: 1;
        }

        .btn-small:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .settings-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-label {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 8px;
        }

        .mode-buttons {
            display: flex;
            gap: 5px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            background: rgba(255,255,255,0.1);
            color: #ccc;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .mode-btn.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 2px 8px rgba(76,175,80,0.3);
        }

        .sensitivity-control,
        .threshold-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sensitivity-control input[type="range"],
        .threshold-control input[type="range"] {
            flex: 1;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            outline: none;
        }

        .sensitivity-control input[type="range"]::-webkit-slider-thumb,
        .threshold-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
        }

        .setting-hint {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
            font-style: italic;
        }

        .sensitivity-value,
        .threshold-value {
            min-width: 35px;
            font-weight: bold;
            color: #fff;
            font-size: 0.85rem;
        }

        .auto-status {
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(244,67,54,0.8);
            display: inline-block;
        }

        .auto-status.active {
            background: rgba(76,175,80,0.8);
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .pressure-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .pressure-grid {
                max-width: 100%;
            }
            
            .pressure-cell {
                width: 15px;
                height: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>智能床垫可视化系统</h1>
            <div class="status-bar">
                <div class="status-item" id="connectionStatus">
                    <span id="statusText">连接中...</span>
                </div>
                <div class="status-item">
                    <span id="currentTime">--:--:--</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="pressure-section">
                <div class="matrix-header">
                    <h2 class="section-title">输入压力矩阵 (1040个传感器数值)</h2>
                    <button class="toggle-matrix-btn" onclick="togglePressureMatrix()" id="matrixToggleBtn">
                        <span class="toggle-icon">▼</span>
                        <span class="toggle-text">收起</span>
                    </button>
                </div>
                <div class="pressure-matrix-display" id="pressureMatrixContainer">
                    <textarea id="pressureMatrix" readonly style="width: 100%; height: 900px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 15px; font-family: monospace; font-size: 11px; resize: none; backdrop-filter: blur(10px); line-height: 1.4;"></textarea>
                </div>
                
                <h2 class="section-title" style="margin-top: 25px;">压力传感器热力图 (40×26)</h2>
                <div class="pressure-grid" id="pressureGrid"></div>
                <div class="pressure-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #000033;"></div>
                        <span>0</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0000ff;"></div>
                        <span>14</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0066ff;"></div>
                        <span>28</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ffff;"></div>
                        <span>42</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff99;"></div>
                        <span>56</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff00;"></div>
                        <span>70</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #99ff00;"></div>
                        <span>84</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffff00;"></div>
                        <span>98</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff9900;"></div>
                        <span>112</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff3300;"></div>
                        <span>126</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff0000;"></div>
                        <span>140+</span>
                    </div>
                </div>
            </div>

            <div class="metrics-section">
                <h2 class="section-title">实时监测指标</h2>
                
                <div class="posture-display">
                    <div class="posture-icon" id="postureIcon">😴</div>
                    <div class="posture-text" id="postureText">无人</div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">平均压力</div>
                    <div class="metric-value" id="avgPressure">0.00</div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">压力指数 (PI)</div>
                    <div class="metric-value" id="pressureIndex">0</div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">接触面指数</div>
                    <div class="metric-value" id="contactIndex">0%</div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">最大压力值</div>
                    <div class="metric-value" id="maxPressure">0</div>
                </div>
                
                <!-- 智能调节设置面板 -->
                <div class="settings-panel">
                    <h3 class="section-title" style="font-size: 1.2rem; margin-bottom: 15px;">智能设置</h3>
                    
                    <div class="setting-item">
                        <div class="setting-label">支撑模式</div>
                        <div class="mode-buttons">
                            <button class="mode-btn" onclick="setSupportMode('soft')">软</button>
                            <button class="mode-btn active" onclick="setSupportMode('balanced')">平衡</button>
                            <button class="mode-btn" onclick="setSupportMode('firm')">硬</button>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">压力敏感度</div>
                        <div class="sensitivity-control">
                            <input type="range" id="sensitivitySlider" min="0.1" max="1.0" step="0.1" value="0.7" 
                                   onchange="setSensitivity(this.value)">
                            <span class="sensitivity-value" id="sensitivityValue">70%</span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">接触压力阈值</div>
                        <div class="threshold-control">
                            <input type="range" id="thresholdSlider" min="0" max="20" step="1" value="5" 
                                   onchange="setPressureThreshold(this.value)">
                            <span class="threshold-value" id="thresholdValue">5</span>
                        </div>
                        <div class="setting-hint">超过此阈值的压力才认为是接触</div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">自动调节状态</div>
                        <div class="auto-status" id="autoStatus">关闭</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="airbag-control">
            <h2 class="section-title">气囊控制面板</h2>
            <div class="airbag-grid" id="airbagGrid">
                <!-- 气囊控制项将通过JS动态生成 -->
            </div>
            <div class="control-buttons">
                <button class="btn" onclick="sendAirbagCommand('open_all')">全部中等高度</button>
                <button class="btn btn-secondary" onclick="sendAirbagCommand('close_all')">全部复位</button>
                <button class="btn" onclick="enableAutoMode()">智能调节</button>
            </div>
        </div>
    </div>

    <script>
        class MattressVisualizer {
            constructor() {
                this.ws = null;
                this.currentData = null;
                this.airbagStates = {}; // 34个气囊状态，使用ID作为key
                this.airbagHeights = {}; // 34个气囊高度(0-100%)
                this.autoMode = false; // 自动调节模式
                this.supportMode = 'balanced'; // 支撑模式：soft/balanced/firm
                this.pressureSensitivity = 0.7; // 压力敏感度(0.1-1.0)
                this.pressureThreshold = 5; // 接触压力阈值(0-20)
                this.matrixExpanded = true; // 矩阵显示状态
                this.initAirbagMappings();
                this.init();
            }

            initAirbagMappings() {
                // 基于40x26传感器网格的气囊区域映射(行,列坐标范围)
                // 坐标系：(0,0)在左上角，行从上到下，列从左到右
                this.airbagRegions = {
                    // 绿色矩形区域 - 大型气囊
                    40: { rows: [0, 4], cols: [2, 23], type: 'rectangle' },    // 头部区域
                    41: { rows: [5, 9], cols: [2, 23], type: 'rectangle' },    // 颈肩区域  
                    42: { rows: [10, 14], cols: [2, 23], type: 'rectangle' }, // 上背区域
                    
                    // 绿色圆形区域 - 中央支撑气囊
                    32: { rows: [15, 18], cols: [0, 3], type: 'circle' },
                    33: { rows: [15, 18], cols: [4, 7], type: 'circle' },
                    34: { rows: [15, 18], cols: [8, 11], type: 'circle' },
                    35: { rows: [15, 18], cols: [12, 15], type: 'circle' },
                    43: { rows: [15, 18], cols: [16, 19], type: 'circle' },
                    
                    24: { rows: [19, 22], cols: [0, 3], type: 'circle' },
                    25: { rows: [19, 22], cols: [4, 7], type: 'circle' },
                    26: { rows: [19, 22], cols: [8, 11], type: 'circle' },
                    27: { rows: [19, 22], cols: [12, 15], type: 'circle' },
                    
                    36: { rows: [23, 26], cols: [0, 3], type: 'circle' },
                    37: { rows: [23, 26], cols: [4, 7], type: 'circle' },
                    38: { rows: [23, 26], cols: [8, 11], type: 'circle' },
                    39: { rows: [23, 26], cols: [12, 15], type: 'circle' },
                    
                    28: { rows: [27, 30], cols: [0, 3], type: 'circle' },
                    29: { rows: [27, 30], cols: [4, 7], type: 'circle' },
                    30: { rows: [27, 30], cols: [8, 11], type: 'circle' },
                    31: { rows: [27, 30], cols: [12, 15], type: 'circle' },
                    
                    20: { rows: [31, 34], cols: [0, 3], type: 'circle' },
                    21: { rows: [31, 34], cols: [4, 7], type: 'circle' },
                    22: { rows: [31, 34], cols: [8, 11], type: 'circle' },
                    23: { rows: [31, 34], cols: [12, 15], type: 'circle' },
                    
                    // 红色圆形区域 - 侧边支撑气囊
                    14: { rows: [15, 18], cols: [20, 23], type: 'circle' },
                    4:  { rows: [19, 22], cols: [20, 23], type: 'circle' },
                    5:  { rows: [19, 22], cols: [24, 25], type: 'circle' },
                    16: { rows: [23, 26], cols: [20, 23], type: 'circle' },
                    17: { rows: [23, 26], cols: [24, 25], type: 'circle' },
                    8:  { rows: [27, 30], cols: [20, 23], type: 'circle' },
                    9:  { rows: [27, 30], cols: [24, 25], type: 'circle' },
                    0:  { rows: [31, 34], cols: [20, 23], type: 'circle' },
                    1:  { rows: [31, 34], cols: [24, 25], type: 'circle' },
                    
                    // 红色矩形区域 - 底部气囊
                    12: { rows: [35, 39], cols: [8, 17], type: 'rectangle' }  // 腿部区域
                };

                // 初始化所有气囊状态
                Object.keys(this.airbagRegions).forEach(id => {
                    this.airbagStates[id] = false;
                    this.airbagHeights[id] = 0; // 初始高度为0%
                });
            }

            init() {
                this.connectWebSocket();
                this.createPressureGrid();
                this.createAirbagGrid();
                this.initSettingsPanel();
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);
            }

            connectWebSocket() {
                this.ws = new WebSocket('ws://127.0.0.1:8000');
                
                this.ws.onopen = () => {
                    this.updateConnectionStatus(true);
                    console.log('WebSocket连接已建立');
                };

                this.ws.onmessage = (event) => {
                    try {
                        this.currentData = JSON.parse(event.data);
                        this.updateVisualization();
                    } catch (error) {
                        console.error('数据解析错误:', error);
                    }
                };

                this.ws.onclose = () => {
                    this.updateConnectionStatus(false);
                    console.log('WebSocket连接已断开');
                    // 5秒后尝试重连
                    setTimeout(() => this.connectWebSocket(), 5000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    this.updateConnectionStatus(false);
                };
            }

            createPressureGrid() {
                const grid = document.getElementById('pressureGrid');
                grid.innerHTML = '';
                
                // 创建40x26=1040个压力传感器格子
                for (let i = 0; i < 1040; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'pressure-cell';
                    cell.id = `cell-${i}`;
                    grid.appendChild(cell);
                }
            }

            createAirbagGrid() {
                const grid = document.getElementById('airbagGrid');
                grid.innerHTML = '';
                
                // 获取所有气囊ID并排序
                const airbagIds = Object.keys(this.airbagRegions).map(id => parseInt(id)).sort((a, b) => a - b);
                
                airbagIds.forEach(id => {
                    const region = this.airbagRegions[id];
                    const item = document.createElement('div');
                    item.className = 'airbag-item';
                    item.id = `airbag-${id}`;
                    
                    // 根据气囊类型设置不同样式
                    const typeClass = region.type === 'rectangle' ? 'airbag-rectangle' : 'airbag-circle';
                    item.classList.add(typeClass);
                    
                    item.innerHTML = `
                        <div class="airbag-number">气囊 ${id}</div>
                        <div class="airbag-height-display">高度: <span class="height-value">0%</span></div>
                        <div class="airbag-controls">
                            <input type="range" class="height-slider" min="0" max="100" value="0" 
                                   onchange="adjustAirbagHeight(${id}, this.value)">
                            <div class="height-buttons">
                                <button class="btn-small" onclick="setAirbagHeight(${id}, 0)">关</button>
                                <button class="btn-small" onclick="setAirbagHeight(${id}, 50)">中</button>
                                <button class="btn-small" onclick="setAirbagHeight(${id}, 100)">高</button>
                            </div>
                        </div>
                    `;
                    
                    grid.appendChild(item);
                });
            }

            updateVisualization() {
                if (!this.currentData) return;

                // 更新压力矩阵显示
                this.updatePressureMatrix();
                
                // 更新压力传感器热力图
                this.updatePressureGrid();
                
                // 更新指标显示
                this.updateMetrics();
                
                // 更新睡眠姿态
                this.updatePosture();
                
                // 如果启用自动模式，执行智能调节
                if (this.autoMode) {
                    this.performAutoAdjustment();
                }
            }

            updatePressureMatrix() {
                if (!this.currentData.pressure) return;
                
                let pressureArray;
                try {
                    pressureArray = JSON.parse(this.currentData.pressure);
                } catch (error) {
                    console.error('压力数据解析错误:', error);
                    return;
                }
                
                if (pressureArray.length !== 1040) {
                    console.error('压力数据长度错误，期望1040个值');
                    return;
                }
                
                // 格式化压力矩阵显示，每行26个值，共40行
                let matrixText = '╔═════════════════════════════════════╗\n';
                matrixText += '║        智能床垫压力传感器矩阵 (40×26)       ║\n';
                matrixText += '╚═════════════════════════════════════╝\n\n';
                
                for (let row = 0; row < 40; row++) {
                    let rowData = [];
                    for (let col = 0; col < 26; col++) {
                        const index = row * 26 + col;
                        const pressure = pressureArray[index];
                        // 格式化为3位数，使用右对齐
                        rowData.push(pressure.toString().padStart(3, ' '));
                    }
                    matrixText += `${(row + 1).toString().padStart(2, '0')}: ${rowData.join(' ')}\n`;
                }
                
                // 添加统计信息
                const totalSensors = pressureArray.length;
                const basicActiveSensors = pressureArray.filter(p => p > 0).length;
                const thresholdActiveSensors = pressureArray.filter(p => p > this.pressureThreshold).length;
                const maxPressure = Math.max(...pressureArray);
                const avgPressure = (pressureArray.reduce((sum, p) => sum + p, 0) / totalSensors).toFixed(2);
                
                matrixText += '\n┌─────────────────────────────────────────────────────────────────────┐\n';
                matrixText += '│                       统计信息                       │\n';
                matrixText += '├─────────────────────────────────────────────────────────────────────┤\n';
                matrixText += `│ 总传感器数量: ${totalSensors.toString().padEnd(35)} │\n`;
                matrixText += `│ 有压力传感器: ${basicActiveSensors.toString().padEnd(34)} │\n`;
                matrixText += `│ 超阈值(>${this.pressureThreshold})传感器: ${thresholdActiveSensors.toString().padEnd(26)} │\n`;
                matrixText += `│ 最大压力值: ${maxPressure.toString().padEnd(36)} │\n`;
                matrixText += `│ 平均压力值: ${avgPressure.toString().padEnd(36)} │\n`;
                matrixText += `│ 接触面指数(阈值=${this.pressureThreshold}): ${(thresholdActiveSensors / totalSensors * 100).toFixed(1)}%`.padEnd(68) + ' │\n';
                matrixText += '│ 接触面覆盖率: ' + `${((thresholdActiveSensors / 1040) * 100).toFixed(2)}%`.padEnd(37) + ' │\n';
                matrixText += '│ 压力分布密度: ' + `${((basicActiveSensors / 1040) * 100).toFixed(2)}%`.padEnd(37) + ' │\n';
                matrixText += '└─────────────────────────────────────────────────────────────────────┘';
                
                const matrixElement = document.getElementById('pressureMatrix');
                if (matrixElement) {
                    matrixElement.value = matrixText;
                    // 自动滚动到顶部
                    matrixElement.scrollTop = 0;
                }
            }

            updatePressureGrid() {
                if (!this.currentData.pressure) return;

                let pressureArray;
                try {
                    pressureArray = JSON.parse(this.currentData.pressure);
                } catch (error) {
                    console.error('压力数据解析错误:', error);
                    return;
                }

                if (pressureArray.length !== 1040) {
                    console.error('压力数据长度错误，期望1040个值');
                    return;
                }

                // 找出最大压力值用于归一化
                const maxPressure = Math.max(...pressureArray);
                const maxPressureElement = document.getElementById('maxPressure');
                if (maxPressureElement) {
                    maxPressureElement.textContent = maxPressure;
                }

                // 更新每个传感器格子的颜色
                pressureArray.forEach((pressure, index) => {
                    const cell = document.getElementById(`cell-${index}`);
                    if (cell) {
                        cell.style.backgroundColor = this.getPressureColor(pressure);
                        cell.title = `位置: ${index}, 压力: ${pressure}`;
                    }
                });
            }

            getPressureColor(pressure) {
                // 高精度连续色彩映射，支持0-140压力值范围
                if (pressure <= 0) return '#000033'; // 深蓝色 - 无压力
                
                // 将压力值映射到0-1范围，最大值设为140
                const normalized = Math.min(pressure / 140, 1.0);
                
                // 定义色彩梯度点 (HSV色彩空间)
                const colorStops = [
                    {pos: 0.0,  h: 240, s: 100, v: 20},   // 深蓝
                    {pos: 0.1,  h: 240, s: 100, v: 50},   // 蓝色
                    {pos: 0.2,  h: 210, s: 100, v: 70},   // 浅蓝
                    {pos: 0.3,  h: 180, s: 100, v: 80},   // 青色
                    {pos: 0.4,  h: 150, s: 100, v: 85},   // 青绿
                    {pos: 0.5,  h: 120, s: 100, v: 90},   // 绿色
                    {pos: 0.6,  h: 90,  s: 100, v: 95},   // 黄绿
                    {pos: 0.7,  h: 60,  s: 100, v: 100},  // 黄色
                    {pos: 0.8,  h: 30,  s: 100, v: 100},  // 橙色
                    {pos: 0.9,  h: 15,  s: 100, v: 100},  // 橘红
                    {pos: 1.0,  h: 0,   s: 100, v: 100}   // 纯红
                ];
                
                // 找到当前位置在哪两个色彩点之间
                let lowerStop = colorStops[0];
                let upperStop = colorStops[colorStops.length - 1];
                
                for (let i = 0; i < colorStops.length - 1; i++) {
                    if (normalized >= colorStops[i].pos && normalized <= colorStops[i + 1].pos) {
                        lowerStop = colorStops[i];
                        upperStop = colorStops[i + 1];
                        break;
                    }
                }
                
                // 在两个色彩点之间进行插值
                const range = upperStop.pos - lowerStop.pos;
                const t = range > 0 ? (normalized - lowerStop.pos) / range : 0;
                
                const h = lowerStop.h + (upperStop.h - lowerStop.h) * t;
                const s = lowerStop.s + (upperStop.s - lowerStop.s) * t;
                const v = lowerStop.v + (upperStop.v - lowerStop.v) * t;
                
                // 将HSV转换为RGB
                return this.hsvToRgb(h, s, v);
            }

            hsvToRgb(h, s, v) {
                h = h / 360;
                s = s / 100;
                v = v / 100;
                
                const c = v * s;
                const x = c * (1 - Math.abs((h * 6) % 2 - 1));
                const m = v - c;
                
                let r, g, b;
                
                if (h < 1/6) {
                    r = c; g = x; b = 0;
                } else if (h < 2/6) {
                    r = x; g = c; b = 0;
                } else if (h < 3/6) {
                    r = 0; g = c; b = x;
                } else if (h < 4/6) {
                    r = 0; g = x; b = c;
                } else if (h < 5/6) {
                    r = x; g = 0; b = c;
                } else {
                    r = c; g = 0; b = x;
                }
                
                r = Math.round((r + m) * 255);
                g = Math.round((g + m) * 255);
                b = Math.round((b + m) * 255);
                
                return `rgb(${r}, ${g}, ${b})`;
            }

            calculateAirbagPressures(pressureArray) {
                // 计算每个气囊区域的平均压力
                const airbagPressures = {};
                
                Object.keys(this.airbagRegions).forEach(airbagId => {
                    const region = this.airbagRegions[airbagId];
                    let totalPressure = 0;
                    let sensorCount = 0;
                    
                    // 遍历该气囊覆盖的传感器区域
                    for (let row = region.rows[0]; row <= region.rows[1]; row++) {
                        for (let col = region.cols[0]; col <= region.cols[1]; col++) {
                            // 转换为传感器数组的索引 (40行x26列)
                            const sensorIndex = row * 26 + col;
                            
                            if (sensorIndex >= 0 && sensorIndex < pressureArray.length) {
                                // 对于圆形气囊，应用简单的圆形遮罩
                                if (region.type === 'circle') {
                                    const centerRow = (region.rows[0] + region.rows[1]) / 2;
                                    const centerCol = (region.cols[0] + region.cols[1]) / 2;
                                    const radiusRow = (region.rows[1] - region.rows[0]) / 2;
                                    const radiusCol = (region.cols[1] - region.cols[0]) / 2;
                                    
                                    const distanceRow = Math.abs(row - centerRow) / radiusRow;
                                    const distanceCol = Math.abs(col - centerCol) / radiusCol;
                                    
                                    // 椭圆形区域检测
                                    if (distanceRow * distanceRow + distanceCol * distanceCol <= 1) {
                                        totalPressure += pressureArray[sensorIndex];
                                        sensorCount++;
                                    }
                                } else {
                                    // 矩形区域，直接包含所有传感器
                                    totalPressure += pressureArray[sensorIndex];
                                    sensorCount++;
                                }
                            }
                        }
                    }
                    
                    // 计算平均压力
                    airbagPressures[airbagId] = sensorCount > 0 ? totalPressure / sensorCount : 0;
                });
                
                return airbagPressures;
            }

            calculateOptimalAirbagHeights(airbagPressures) {
                // 智能压力-高度映射算法
                const optimalHeights = {};
                
                // 定义不同身体部位的支撑策略
                const bodyRegionStrategies = {
                    // 头部区域(40,41,42) - 需要轻度支撑
                    head: { airbags: [40, 41, 42], baseHeight: 20, pressureMultiplier: 0.3 },
                    // 肩背区域 - 需要中等支撑
                    shoulder: { airbags: [32, 33, 34, 35, 43], baseHeight: 40, pressureMultiplier: 0.5 },
                    // 腰部区域 - 需要强力支撑
                    waist: { airbags: [24, 25, 26, 27], baseHeight: 60, pressureMultiplier: 0.8 },
                    // 背部中段
                    back: { airbags: [36, 37, 38, 39], baseHeight: 50, pressureMultiplier: 0.6 },
                    // 下背部
                    lowerBack: { airbags: [28, 29, 30, 31], baseHeight: 55, pressureMultiplier: 0.7 },
                    // 腿部区域
                    legs: { airbags: [20, 21, 22, 23, 12], baseHeight: 30, pressureMultiplier: 0.4 },
                    // 侧边支撑
                    side: { airbags: [14, 4, 5, 16, 17, 8, 9, 0, 1], baseHeight: 35, pressureMultiplier: 0.4 }
                };

                // 支撑模式调节系数
                const modeMultipliers = {
                    soft: 0.7,
                    balanced: 1.0,
                    firm: 1.3
                };

                const modeMultiplier = modeMultipliers[this.supportMode] || 1.0;

                // 为每个气囊计算最佳高度
                Object.keys(airbagPressures).forEach(airbagId => {
                    const pressure = airbagPressures[airbagId];
                    const id = parseInt(airbagId);
                    
                    // 找到该气囊属于哪个身体区域
                    let strategy = null;
                    for (const [regionName, regionStrategy] of Object.entries(bodyRegionStrategies)) {
                        if (regionStrategy.airbags.includes(id)) {
                            strategy = regionStrategy;
                            break;
                        }
                    }

                    if (strategy) {
                        // 计算基础高度
                        let targetHeight = strategy.baseHeight;
                        
                        // 根据压力调整高度
                        if (pressure > 0) {
                            // 压力越大，需要更多支撑
                            const pressureAdjustment = (pressure / 50) * strategy.pressureMultiplier * 100;
                            targetHeight += pressureAdjustment * this.pressureSensitivity;
                        } else {
                            // 无压力区域降低高度
                            targetHeight *= 0.3;
                        }
                        
                        // 应用支撑模式调节
                        targetHeight *= modeMultiplier;
                        
                        // 限制在合理范围内
                        targetHeight = Math.max(0, Math.min(100, Math.round(targetHeight)));
                        
                        optimalHeights[airbagId] = targetHeight;
                    } else {
                        // 未分类的气囊使用默认策略
                        const defaultHeight = pressure > 0 ? Math.min(50, pressure * 2) : 0;
                        optimalHeights[airbagId] = Math.round(defaultHeight * modeMultiplier);
                    }
                });

                return optimalHeights;
            }

            enableAutoMode() {
                this.autoMode = !this.autoMode;
                const button = document.querySelector('button[onclick="enableAutoMode()"]');
                if (button) {
                    button.textContent = this.autoMode ? '停止智能调节' : '智能调节';
                    button.className = this.autoMode ? 'btn btn-secondary' : 'btn';
                }
                
                // 更新自动调节状态显示
                this.updateAutoStatus();
                
                if (this.autoMode && this.currentData) {
                    this.performAutoAdjustment();
                }
                
                console.log(`自动调节模式: ${this.autoMode ? '开启' : '关闭'}`);
            }

            setSupportMode(mode) {
                this.supportMode = mode;
                
                // 更新按钮状态
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.querySelector(`button[onclick="setSupportMode('${mode}')"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                console.log(`支撑模式切换为: ${mode}`);
                
                // 如果正在自动模式，立即应用新设置
                if (this.autoMode && this.currentData) {
                    this.performAutoAdjustment();
                }
            }

            setSensitivity(value) {
                this.pressureSensitivity = parseFloat(value);
                
                // 更新显示值
                const sensitivityValue = document.getElementById('sensitivityValue');
                if (sensitivityValue) {
                    sensitivityValue.textContent = `${Math.round(this.pressureSensitivity * 100)}%`;
                }
                
                console.log(`压力敏感度调整为: ${this.pressureSensitivity}`);
                
                // 如果正在自动模式，立即应用新设置
                if (this.autoMode && this.currentData) {
                    this.performAutoAdjustment();
                }
            }

            setPressureThreshold(value) {
                this.pressureThreshold = parseInt(value);
                
                // 更新显示值
                const thresholdValue = document.getElementById('thresholdValue');
                if (thresholdValue) {
                    thresholdValue.textContent = this.pressureThreshold;
                }
                
                console.log(`接触压力阈值调整为: ${this.pressureThreshold}`);
                
                // 立即重新计算接触面指数
                if (this.currentData) {
                    this.updateMetrics();
                    this.updatePressureMatrix();
                }
            }

            togglePressureMatrix() {
                this.matrixExpanded = !this.matrixExpanded;
                
                const container = document.getElementById('pressureMatrixContainer');
                const toggleBtn = document.getElementById('matrixToggleBtn');
                const toggleIcon = toggleBtn.querySelector('.toggle-icon');
                const toggleText = toggleBtn.querySelector('.toggle-text');
                
                if (this.matrixExpanded) {
                    // 展开状态
                    container.classList.remove('collapsed');
                    toggleBtn.classList.remove('collapsed');
                    toggleIcon.textContent = '▼';
                    toggleText.textContent = '收起';
                } else {
                    // 收起状态
                    container.classList.add('collapsed');
                    toggleBtn.classList.add('collapsed');
                    toggleIcon.textContent = '▶';
                    toggleText.textContent = '展开';
                }
                
                console.log(`压力矩阵显示状态: ${this.matrixExpanded ? '展开' : '收起'}`);
            }

            updateAutoStatus() {
                const autoStatus = document.getElementById('autoStatus');
                if (autoStatus) {
                    autoStatus.textContent = this.autoMode ? '开启' : '关闭';
                    autoStatus.className = this.autoMode ? 'auto-status active' : 'auto-status';
                }
            }

            initSettingsPanel() {
                // 设置默认支撑模式按钮状态
                const balancedBtn = document.querySelector("button[onclick=\"setSupportMode('balanced')\"]");
                if (balancedBtn) {
                    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                    balancedBtn.classList.add('active');
                }
                
                // 设置默认敏感度显示
                const sensitivityValue = document.getElementById('sensitivityValue');
                if (sensitivityValue) {
                    sensitivityValue.textContent = `${Math.round(this.pressureSensitivity * 100)}%`;
                }
                
                // 设置默认阈值显示
                const thresholdValue = document.getElementById('thresholdValue');
                if (thresholdValue) {
                    thresholdValue.textContent = this.pressureThreshold;
                }
                
                // 初始化自动状态显示
                this.updateAutoStatus();
            }

            performAutoAdjustment() {
                if (!this.autoMode || !this.currentData) return;

                try {
                    const pressureArray = JSON.parse(this.currentData.pressure);
                    const airbagPressures = this.calculateAirbagPressures(pressureArray);
                    const optimalHeights = this.calculateOptimalAirbagHeights(airbagPressures);
                    
                    // 平滑调节到目标高度，避免突然变化
                    Object.keys(optimalHeights).forEach(airbagId => {
                        const targetHeight = optimalHeights[airbagId];
                        const currentHeight = this.airbagHeights[airbagId] || 0;
                        
                        // 逐步调节到目标高度
                        const heightDiff = targetHeight - currentHeight;
                        const adjustStep = Math.sign(heightDiff) * Math.min(Math.abs(heightDiff), 5); // 每次最多调节5%
                        
                        const newHeight = currentHeight + adjustStep;
                        this.setAirbagHeight(airbagId, newHeight);
                    });
                    
                    console.log('执行智能调节:', optimalHeights);
                } catch (error) {
                    console.error('智能调节错误:', error);
                }
            }

            calculateRealTimeMetrics(pressureArray) {
                if (!pressureArray || pressureArray.length !== 1040) {
                    return {
                        avgPressure: 0,
                        pressureIndex: 0,
                        contactIndex: 0,
                        maxPressure: 0
                    };
                }
                
                // 计算平均压力
                const totalPressure = pressureArray.reduce((sum, pressure) => sum + pressure, 0);
                const avgPressure = totalPressure / 1040;
                
                // 计算最大压力
                const maxPressure = Math.max(...pressureArray);
                
                // 计算接触面指数 (超过阈值的传感器数量 / 总传感器数量 * 100%)
                const activeSensors = pressureArray.filter(pressure => pressure > this.pressureThreshold).length;
                const contactIndex = (activeSensors / 1040) * 100;
                
                // 计算压力指数 (基于压力分布和强度的综合指标)
                // 使用加权公式：考虑压力总和和分布密度
                const nonZeroPressures = pressureArray.filter(p => p > 0);
                let pressureIndex = 0;
                if (nonZeroPressures.length > 0) {
                    const avgNonZero = nonZeroPressures.reduce((sum, p) => sum + p, 0) / nonZeroPressures.length;
                    const distributionFactor = nonZeroPressures.length / 1040; // 压力分布密度
                    pressureIndex = avgNonZero * distributionFactor * 10; // 缩放系数
                }
                
                return {
                    avgPressure: parseFloat(avgPressure.toFixed(2)),
                    pressureIndex: parseFloat(pressureIndex.toFixed(2)), 
                    contactIndex: parseFloat(contactIndex.toFixed(1)),
                    maxPressure: maxPressure
                };
            }

            updateMetrics() {
                if (!this.currentData) return;

                // 获取压力数组进行实时计算
                let pressureArray = [];
                try {
                    pressureArray = JSON.parse(this.currentData.pressure);
                } catch (error) {
                    console.error('压力数据解析错误:', error);
                    return;
                }

                // 计算实时指标
                const realTimeMetrics = this.calculateRealTimeMetrics(pressureArray);
                
                // 更新界面指标显示
                const elements = {
                    avgPressure: realTimeMetrics.avgPressure.toFixed(2),
                    pressureIndex: realTimeMetrics.pressureIndex.toFixed(2),
                    contactIndex: realTimeMetrics.contactIndex.toFixed(1) + '%',
                    maxPressure: realTimeMetrics.maxPressure
                };

                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });
            }

            updatePosture() {
                if (!this.currentData) return;

                const postureIcon = document.getElementById('postureIcon');
                const postureText = document.getElementById('postureText');
                
                if (!postureIcon || !postureText) return;

                const posture = this.currentData.posture;
                
                switch (posture) {
                    case 'no':
                        postureIcon.textContent = '🛏️';
                        postureText.textContent = '无人';
                        break;
                    case 'supine':
                        postureIcon.textContent = '🛌';
                        postureText.textContent = '仰卧';
                        break;
                    case 'side':
                        postureIcon.textContent = '😴';
                        postureText.textContent = '侧卧';
                        break;
                    default:
                        postureIcon.textContent = '❓';
                        postureText.textContent = '未知';
                }
            }

            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusElement.className = 'status-item status-connected';
                    statusText.textContent = '已连接';
                } else {
                    statusElement.className = 'status-item status-disconnected';
                    statusText.textContent = '连接断开';
                }
            }

            updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = timeString;
                }
            }

            setAirbagHeight(id, height) {
                this.airbagHeights[id] = Math.max(0, Math.min(100, height));
                this.updateAirbagDisplay(id);
                this.sendAirbagCommand();
            }

            adjustAirbagHeight(id, height) {
                this.setAirbagHeight(id, parseInt(height));
            }

            updateAirbagDisplay(id) {
                const airbagElement = document.getElementById(`airbag-${id}`);
                const heightValueElement = airbagElement.querySelector('.height-value');
                const sliderElement = airbagElement.querySelector('.height-slider');
                
                if (heightValueElement) {
                    heightValueElement.textContent = `${this.airbagHeights[id]}%`;
                }
                
                if (sliderElement) {
                    sliderElement.value = this.airbagHeights[id];
                }
                
                // 根据高度调整视觉样式
                const height = this.airbagHeights[id];
                if (height > 0) {
                    airbagElement.style.boxShadow = `0 0 ${height/10}px rgba(76,175,80,0.6)`;
                    airbagElement.style.background = `rgba(76,175,80,${0.2 + height/500})`;
                } else {
                    airbagElement.style.boxShadow = 'none';
                    const region = this.airbagRegions[id];
                    if (region.type === 'rectangle') {
                        airbagElement.style.background = 'rgba(76,175,80,0.2)';
                    } else {
                        airbagElement.style.background = 'rgba(33,150,243,0.2)';
                    }
                }
            }

            sendAirbagCommand(command = null) {
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    console.log('WebSocket未连接');
                    return;
                }

                let airbagData = {};
                
                if (command === 'open_all') {
                    // 全部开启到50%高度
                    Object.keys(this.airbagRegions).forEach(id => {
                        this.airbagHeights[id] = 50;
                        airbagData[id] = 50;
                    });
                } else if (command === 'close_all') {
                    // 全部关闭到0%高度
                    Object.keys(this.airbagRegions).forEach(id => {
                        this.airbagHeights[id] = 0;
                        airbagData[id] = 0;
                    });
                } else {
                    // 发送当前所有气囊高度
                    airbagData = {...this.airbagHeights};
                }

                const data = {
                    airbag_heights: JSON.stringify(airbagData),
                    time: "5"
                };

                this.ws.send(JSON.stringify(data));
                console.log('发送气囊高度控制命令:', data);

                // 更新所有气囊显示
                Object.keys(this.airbagRegions).forEach(id => {
                    this.updateAirbagDisplay(id);
                });
            }
        }

        // 全局函数供按钮调用
        let visualizer;

        function sendAirbagCommand(command) {
            if (visualizer) {
                visualizer.sendAirbagCommand(command);
            }
        }

        function setAirbagHeight(id, height) {
            if (visualizer) {
                visualizer.setAirbagHeight(id, height);
            }
        }

        function adjustAirbagHeight(id, height) {
            if (visualizer) {
                visualizer.adjustAirbagHeight(id, height);
            }
        }

        function enableAutoMode() {
            if (visualizer) {
                visualizer.enableAutoMode();
            }
        }

        function setSupportMode(mode) {
            if (visualizer) {
                visualizer.setSupportMode(mode);
            }
        }

        function setSensitivity(value) {
            if (visualizer) {
                visualizer.setSensitivity(value);
            }
        }

        function setPressureThreshold(value) {
            if (visualizer) {
                visualizer.setPressureThreshold(value);
            }
        }

        function togglePressureMatrix() {
            if (visualizer) {
                visualizer.togglePressureMatrix();
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            visualizer = new MattressVisualizer();
        });
    </script>
</body>
</html>